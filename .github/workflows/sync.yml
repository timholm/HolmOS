name: Sync Cluster to GitHub

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

env:
  PI_HOST: 192.168.8.197
  PI_USER: rpi1

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest from cluster
        env:
          PI_PASSWORD: ${{ secrets.PI_PASSWORD }}
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass

          # Create builds archive on Pi
          sshpass -p "$PI_PASSWORD" ssh -o StrictHostKeyChecking=no \
            ${{ env.PI_USER }}@${{ env.PI_HOST }} \
            "cd /home/rpi1 && tar czf /tmp/builds-sync.tar.gz builds 2>/dev/null || true"

          # Download
          sshpass -p "$PI_PASSWORD" scp -o StrictHostKeyChecking=no \
            ${{ env.PI_USER }}@${{ env.PI_HOST }}:/tmp/builds-sync.tar.gz \
            /tmp/ 2>/dev/null || true

          # Extract and merge
          if [ -f /tmp/builds-sync.tar.gz ]; then
            tar xzf /tmp/builds-sync.tar.gz -C /tmp/
            rsync -av /tmp/builds/ services/ 2>/dev/null || true
          fi

      - name: Commit changes
        run: |
          git config user.name "HolmOS Bot"
          git config user.email "bot@holmos.local"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "sync: Update services from cluster [skip ci]"
            git push
          else
            echo "No changes to sync"
          fi

  inventory:
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Generate service inventory
        env:
          PI_PASSWORD: ${{ secrets.PI_PASSWORD }}
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass

          sshpass -p "$PI_PASSWORD" ssh -o StrictHostKeyChecking=no \
            ${{ env.PI_USER }}@${{ env.PI_HOST }} << 'INVENTORY' > inventory.md

          echo "# HolmOS Service Inventory"
          echo ""
          echo "Generated: $(date -u)"
          echo ""

          echo "## Cluster Stats"
          echo "- Nodes: $(kubectl get nodes --no-headers | wc -l)"
          echo "- Deployments: $(kubectl get deployments -n holm --no-headers | wc -l)"
          echo "- Pods: $(kubectl get pods -n holm --no-headers | wc -l)"
          echo "- Running: $(kubectl get pods -n holm --no-headers | grep Running | wc -l)"
          echo ""

          echo "## Services by Category"
          echo ""
          echo "### Core"
          kubectl get svc -n holm -o custom-columns=NAME:.metadata.name,PORT:.spec.ports[0].nodePort --no-headers | grep -E "^(holmos|claude|app-store|chat)" | sort

          echo ""
          echo "### Agents"
          kubectl get svc -n holm -o custom-columns=NAME:.metadata.name,PORT:.spec.ports[0].nodePort --no-headers | grep -E "^(nova|merchant|pulse|gateway|scribe|vault|echo|sentinel|helix|compass|forge)" | sort

          echo ""
          echo "### Apps"
          kubectl get svc -n holm -o custom-columns=NAME:.metadata.name,PORT:.spec.ports[0].nodePort --no-headers | grep -E "(app|clock|calculator|notes|music|photos|browser|mail|maps)" | sort

          echo ""
          echo "### DevOps"
          kubectl get svc -n holm -o custom-columns=NAME:.metadata.name,PORT:.spec.ports[0].nodePort --no-headers | grep -E "(git|cicd|deploy|registry)" | sort

          INVENTORY

          cat inventory.md >> $GITHUB_STEP_SUMMARY
